# рж░рж┐ржлрж╛ржирзНржб рж╕ржорзНржкрзВрж░рзНржг ржХрж░рж╛рж░ ржкрж░ ржЗржиржнрзЗржирзНржЯрж░рж┐ ржкрзБржирж░рзБржжрзНржзрж╛рж░

**рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕:** тЬЕ **рж╕ржорзНржкрзВрж░рзНржг ржмрж╛рж╕рзНрждржмрж╛ржпрж╝рж┐ржд**

---

## ЁЯОп ржмрзИрж╢рж┐рж╖рзНржЯрзНржп

ржпржЦржи ржПржХржЯрж┐ рж░рж┐ржлрж╛ржирзНржб "рж╕ржорзНржкрзВрж░рзНржг" ржХрж░рж╛ рж╣ржпрж╝, ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржШржЯрзЗ:

### 1я╕ПтГг ржорзВрж▓ ржмрж┐ржХрзНрж░ржпрж╝ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рж╛
```
тЬЕ ржмрж┐ржХрзНрж░ржпрж╝ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ тЖТ "returned" ржП ржЖржкржбрзЗржЯ рж╣ржпрж╝
тЬЕ ржмрж┐ржХрзНрж░ржпрж╝ рждрж╛рж▓рж┐ржХрж╛ржпрж╝ рж▓рзБржХрж╛ржирзЛ рж╣ржпрж╝ (рж╕рзЗрж▓рж╕ ржкрзГрж╖рзНржарж╛ржпрж╝ ржжрзГрж╢рзНржпржорж╛ржи ржиржпрж╝)
```

### 2я╕ПтГг ржкржгрзНржп ржЗржиржнрзЗржирзНржЯрж░рж┐рждрзЗ ржкрзБржирж░рзБржжрзНржзрж╛рж░
```
тЬЕ ржкрзНрж░рждрж┐ржЯрж┐ рж░рж┐ржлрж╛ржирзНржбржХрзГржд ржкржгрзНржпрзЗрж░ ржкрж░рж┐ржорж╛ржг рж╕рзНржЯржХрзЗ ржпрзЛржЧ рж╣ржпрж╝
тЬЕ ржкржгрзНржп рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ тЖТ "active" (ржХрзНрж░ржпрж╝рзЗрж░ ржЬржирзНржп ржЙржкрж▓ржмрзНржз)
тЬЕ рж╕рзНржЯржХ ржорзБржнржорзЗржирзНржЯ рж░рзЗржХрж░рзНржб ржХрж░рж╛ рж╣ржпрж╝ ("Refund Return" рж╣рж┐рж╕рж╛ржмрзЗ)
```

### 3я╕ПтГг ржЕржбрж┐ржЯ ржЯрзНрж░рзЗржЗрж▓
```
тЬЕ рж╕ржм ржкрж░рж┐ржмрж░рзНрждржи рж▓ржЧ ржХрж░рж╛ рж╣ржпрж╝
тЬЕ рж░рж┐ржлрж╛ржирзНржб ржиржорзНржмрж░ рж╕ржВрж░ржХрзНрж╖рж┐ржд
тЬЕ ржорзВрж▓ ржмрж┐ржХрзНрж░ржпрж╝ ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рж╛ рж╣ржпрж╝
```

---

## ЁЯУЭ ржкрзНрж░ржпрзБржХрзНрждрж┐ржЧржд ржкрж░рж┐ржмрж░рзНрждржи

### ржлрж╛ржЗрж▓ 1: `convex/refunds.ts` - рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржб ржлрж╛ржВрж╢ржи

**ржпрзЛржЧ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:**
```typescript
// тЬЕ Mark original sale as "returned" to hide from sales list
if (refund.saleId) {
  const sale = await ctx.db.get(refund.saleId);
  if (sale) {
    await ctx.db.patch(refund.saleId, {
      status: "returned",
    });
  }
}
```

**ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:**
```typescript
// тЬЕ Mark product as active/available again
const product = await ctx.db.get(item.productId);
if (product) {
  const newStock = (product.currentStock || 0) + item.quantity;
  await ctx.db.patch(item.productId, {
    currentStock: newStock,
    status: "active", // тЬЕ Mark as active/available
  });
}
```

**ржЕржбрж┐ржЯ ржЯрзНрж░рзЗржЗрж▓ ржмрж╛рж░рзНрждрж╛ ржЖржкржбрзЗржЯ:**
```typescript
notes: `Refund completed. Return condition: ${args.returnCondition || "Not specified"}. Original sale marked as returned.`,
```

### ржлрж╛ржЗрж▓ 2: `convex/sales.ts` - ржмрж┐ржХрзНрж░ржпрж╝ рждрж╛рж▓рж┐ржХрж╛ ржлрж┐рж▓рзНржЯрж╛рж░рж┐ржВ

**ржирждрзБржи ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржпрзЛржЧ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:**
```typescript
includeReturned: v.optional(v.boolean()), // тЬЕ Option to include returned sales
```

**рж░рж┐ржлрж╛ржирзНржб ржХрж░рж╛ ржмрж┐ржХрзНрж░ржпрж╝ рж▓рзБржХрж╛ржирзЛ:**
```typescript
// тЬЕ Filter out returned sales by default
if (!args.includeReturned) {
  sales = sales.filter(sale => sale.status !== "returned");
}
```

---

## ЁЯФД рж░рж┐ржлрж╛ржирзНржб рж╕ржорзНржкрзВрж░рзНржг ржХрж░рж╛рж░ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛

```
1. рж░рж┐ржлрж╛ржирзНржб "рж╕ржорзНржкрзВрж░рзНржг" ржмрзЛрждрж╛ржо ржХрзНрж▓рж┐ржХ ржХрж░рзБржи
   тЖУ
2. Return Condition ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи (Good/Fair/Damaged)
   тЖУ
3. рж╕рж┐рж╕рзНржЯрзЗржо рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ:
   тЬЕ рж░рж┐ржлрж╛ржирзНржб рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ тЖТ "completed"
   тЬЕ ржорзВрж▓ ржмрж┐ржХрзНрж░ржпрж╝ тЖТ "returned" (рж▓рзБржХрж╛ржирзЛ)
   тЬЕ ржкржгрзНржп рж╕рзНржЯржХ тЖТ ржмрзГржжрзНржзрж┐ (ржкрж░рж┐ржорж╛ржг ржпрзЛржЧ)
   тЬЕ ржкржгрзНржп рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ тЖТ "active" (ржЙржкрж▓ржмрзНржз)
   тЬЕ рж╕рзНржЯржХ ржорзБржнржорзЗржирзНржЯ тЖТ рж░рзЗржХрж░рзНржб ржХрж░рж╛
   тЬЕ ржЕржбрж┐ржЯ ржЯрзНрж░рзЗржЗрж▓ тЖТ рж▓ржЧ ржХрж░рж╛
```

---

## ЁЯУК ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА ржжрзГрж╢рзНржп

### рж╕рзЗрж▓рж╕ ржкрзГрж╖рзНржарж╛
```
рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржбрзЗрж░ ржЖржЧрзЗ:
- ржмрж┐ржХрзНрж░ржпрж╝ рж░рзЗржХрж░рзНржб ржжрзГрж╢рзНржпржорж╛ржи
- рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: "completed"

рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржбрзЗрж░ ржкрж░рзЗ:
- ржмрж┐ржХрзНрж░ржпрж╝ рж░рзЗржХрж░рзНржб рж▓рзБржХрж╛ржирзЛ
- (рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: "returned" - ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ)
```

### ржЗржиржнрзЗржирзНржЯрж░рж┐ ржкрзГрж╖рзНржарж╛
```
рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржбрзЗрж░ ржЖржЧрзЗ:
- рж╕рзНржЯржХ: 5 ржЗржЙржирж┐ржЯ
- рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: "active" ржмрж╛ "low_stock"

рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржбрзЗрж░ ржкрж░рзЗ:
- рж╕рзНржЯржХ: 5 + 2 (рж░рж┐ржлрж╛ржирзНржб) = 7 ржЗржЙржирж┐ржЯ
- рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: "active" (ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛)
```

### рж░рж┐ржлрж╛ржирзНржб ржкрзГрж╖рзНржарж╛
```
рж╕ржм рж░рж┐ржлрж╛ржирзНржб:
- рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржб ржжрзЗржЦрж╛ ржпрж╛ржпрж╝
- рж╕ржорзНржкрзВрж░рзНржг рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ рж╕рж╣
- ржЕржбрж┐ржЯ рж▓ржЧ рж╕рж╣
```

---

## тЬЕ рж╕ржорзНржкрзВрж░рзНржгрждрж╛ ржЪрзЗржХрж▓рж┐рж╕рзНржЯ

- [x] ржмрж┐ржХрзНрж░ржпрж╝ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ "returned" ржП ржЖржкржбрзЗржЯ ржХрж░рж╛
- [x] ржкржгрзНржп рж╕рзНржЯржХ ржмрзГржжрзНржзрж┐ ржХрж░рж╛
- [x] ржкржгрзНржп рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ "active" ржП рж╕рзЗржЯ ржХрж░рж╛
- [x] рж╕рзНржЯржХ ржорзБржнржорзЗржирзНржЯ рж░рзЗржХрж░рзНржб ржХрж░рж╛
- [x] ржЕржбрж┐ржЯ ржЯрзНрж░рзЗржЗрж▓ ржЖржкржбрзЗржЯ ржХрж░рж╛
- [x] ржмрж┐ржХрзНрж░ржпрж╝ рждрж╛рж▓рж┐ржХрж╛ ржлрж┐рж▓рзНржЯрж╛рж░рж┐ржВ ржХрж░рж╛
- [x] TypeScript ржХржорзНржкрж╛ржЗрж▓рзЗрж╢ржи ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛

---

## ЁЯФН ржпрж╛ржЪрж╛ржЗржХрж░ржг

**TypeScript ржкрж░рзАржХрзНрж╖рж╛:**
```bash
тЬЕ npx tsc --noEmit
   0 errors
```

---

## ЁЯУЪ рж╕ржорзНржкрж░рзНржХрж┐ржд ржбржХрзБржорзЗржирзНржЯрзЗрж╢ржи

- REFUND_MANAGEMENT_SYSTEM.md - рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржлрж╛ржирзНржб рж╕рж┐рж╕рзНржЯрзЗржо
- REFUND_USAGE_GUIDE.md - ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА ржЧрж╛ржЗржб
- REFUND_FIXREPORT.md - ржЯрзЗржХржирж┐ржХрзНржпрж╛рж▓ ржмрж┐рж╢ржж

---

## ЁЯОК рж╕рж┐рж╕рзНржЯрзЗржо рж╕ржорзНржкрзВрж░рзНржг!

ржПржЦржи:
тЬЕ рж░рж┐ржлрж╛ржирзНржб рж╕ржорзНржкрзВрж░рзНржг ржХрж░рж▓рзЗ ржорзВрж▓ ржмрж┐ржХрзНрж░ржпрж╝ рж▓рзБржХрж╛ржирзЛ рж╣ржпрж╝
тЬЕ рж░рж┐ржлрж╛ржирзНржбржХрзГржд ржкржгрзНржп ржЗржиржнрзЗржирзНржЯрж░рж┐рждрзЗ ржкрзБржирж░рзБржжрзНржзрж╛рж░ рж╣ржпрж╝
тЬЕ рж╕рзЗрж▓рж╕ ржкрзГрж╖рзНржарж╛ржпрж╝ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рж╛ ржкржгрзНржп ржжрзЗржЦрж╛ ржпрж╛ржпрж╝ ржирж╛
тЬЕ рж╕ржорзНржкрзВрж░рзНржг ржЕржбрж┐ржЯ ржЯрзНрж░рзЗржЗрж▓ ржмржЬрж╛ржпрж╝ рж░рж╛ржЦрж╛ рж╣ржпрж╝
