## ЁЯОп ржжрзНрж░рзБржд рж╕рзНржЯрж╛рж░рзНржЯ - рж░рж┐ржлрж╛ржирзНржб ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛

**ржЖржкржирж╛рж░ ржжрзБржЯрж┐ ржмрж┐ржХрзНрж░ржпрж╝ рж░рж┐ржлрж╛ржирзНржб ржХрж░рждрзЗ:**

---

## 1я╕ПтГг ржкрзНрж░ржержо ржкржжржХрзНрж╖рзЗржк: ржмрж┐ржХрзНрж░ржпрж╝ ржЦрзБржБржЬрзБржи

**Convex Dashboard ржЦрзБрж▓рзБржи:**
1. `https://dashboard.convex.cloud/` ржпрж╛ржи
2. ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯ ржЦрзБрж▓рзБржи
3. **Data** ржЯрзНржпрж╛ржм тЖТ **sales** ржЯрзЗржмрж┐рж▓
4. **Filter ржмрж╛ Search** ржХрж░рзБржи:
   ```
   saleNumber = "INV-1769778062695"
   ```
   ржПржмржВ
   ```
   saleNumber = "INV-1769776643529"
   ```

**ржирзЛржЯ ржХрж░рзБржи:**
- Sale ID (e.g., `jx123...`)
- Customer Name
- Total Amount
- Branch ID
- All items рж╕рж╣

---

## 2я╕ПтГг ржжрзНржмрж┐рждрзАржпрж╝ ржкржжржХрзНрж╖рзЗржк: Refund рж░рзЗржХрж░рзНржб рждрзИрж░рж┐ ржХрж░рзБржи

### Refund #1 рждрзИрж░рж┐ ржХрж░рзБржи:

**Data ржЯрзНржпрж╛ржм тЖТ refunds тЖТ "+ Insert document"**

ржирж┐ржорзНржирзЛржХрзНржд JSON ржкрзЗрж╕рзНржЯ ржХрж░рзБржи (ржЙржкрж░рзЗрж░ рждржерзНржп ржжрж┐ржпрж╝рзЗ ржкрзНрж░рждрж┐рж╕рзНржерж╛ржкржи ржХрж░рзБржи):

```json
{
  "refundNumber": "REF-1769778062695-MANUAL",
  "saleId": "PASTE_SALE_ID_HERE",
  "saleNumber": "INV-1769778062695",
  "branchId": "PASTE_BRANCH_ID_HERE",
  "branchName": "BRANCH_NAME",
  "customerId": "PASTE_CUSTOMER_ID_HERE",
  "customerName": "CUSTOMER_NAME",
  "customerPhone": "",
  "items": [
    {
      "productId": "PRODUCT_ID_1",
      "productName": "Product Name",
      "quantity": 1,
      "unitPrice": 100,
      "totalPrice": 100,
      "size": null,
      "reason": "Full Refund",
      "condition": "new",
      "notes": "Admin refund"
    }
  ],
  "subtotal": 100,
  "tax": 0,
  "discount": 0,
  "refundAmount": 100,
  "refundMethod": "card",
  "originalPaymentMethod": "card",
  "status": "pending",
  "approvalStatus": "pending_approval",
  "refundReason": "Admin Refund",
  "refundNotes": "Full refund and restock",
  "requestDate": 1738718400000,
  "isReturned": false,
  "restockRequired": true
}
```

тЬЕ **рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи** тЖТ **Refund ID ржирзЛржЯ ржХрж░рзБржи**

---

### Refund #2 рждрзИрж░рж┐ ржХрж░рзБржи:

ржПржХржЗ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ ржжрзНржмрж┐рждрзАржпрж╝ ржмрж┐ржХрзНрж░ржпрж╝рзЗрж░ рж╕рж╛ржерзЗ:
- saleNumber: `INV-1769776643529`
- refundNumber: `REF-1769776643529-MANUAL`
- рж╕ржм ржмрж┐ржмрж░ржг ржЕржирзБржпрж╛ржпрж╝рзА ржЖржкржбрзЗржЯ ржХрж░рзБржи

тЬЕ **Refund ID ржирзЛржЯ ржХрж░рзБржи**

---

## 3я╕ПтГг рждрзГрждрзАржпрж╝ ржкржжржХрзНрж╖рзЗржк: Refund ржЕржирзБржорзЛржжржи ржХрж░рзБржи

### Refund #1 ржЕржирзБржорзЛржжржи ржХрж░рзБржи:

**Functions ржЯрзНржпрж╛ржм тЖТ `refunds.approve` ржЦрзБржБржЬрзБржи тЖТ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи**

**Arguments ржП:**
```json
{
  "refundId": "PASTE_REFUND_ID_1",
  "approvalNotes": "Approved for full refund and restock"
}
```

тЬЕ **Call Function** ржХрзНрж▓рж┐ржХ ржХрж░рзБржи

**ржкрзНрж░рждрзНржпрж╛рж╢рж╛:** `{ "success": true, ... }`

---

### Refund #2 ржЕржирзБржорзЛржжржи ржХрж░рзБржи:

ржПржХржЗ ржзрж╛ржк, Refund ID #2 ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи

---

## 4я╕ПтГг ржЪрждрзБрж░рзНрже ржкржжржХрзНрж╖рзЗржк: Refund ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзБржи

### Refund #1 ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзБржи:

**Functions ржЯрзНржпрж╛ржм тЖТ `refunds.process` ржЦрзБржБржЬрзБржи тЖТ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи**

**Arguments ржП:**
```json
{
  "refundId": "PASTE_REFUND_ID_1",
  "refundDetails": {
    "transactionId": "MANUAL-1",
    "phoneNumber": "",
    "reference": "INV-1769778062695",
    "status": "completed",
    "remark": "Manual admin process"
  }
}
```

тЬЕ **Call Function** ржХрзНрж▓рж┐ржХ ржХрж░рзБржи

---

### Refund #2 ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзБржи:

ржПржХржЗ ржзрж╛ржк, Refund ID #2 рж╕рж╣

---

## 5я╕ПтГг ржкржЮрзНржЪржо ржкржжржХрзНрж╖рзЗржк: Refund рж╕ржорзНржкржирзНржи ржХрж░рзБржи (Undo Sale)

> тЪая╕П **ржПржЯрж┐ рж╕ржм ржкрж░рж┐ржмрж░рзНрждржи рж╕ржХрзНрж░рж┐ржпрж╝ ржХрж░рзЗ тАФ рж╕рзНржЯржХ, рж▓ржпрж╝рзНржпрж╛рж▓ржЯрж┐, ржЗрждрзНржпрж╛ржжрж┐**

### Refund #1 рж╕ржорзНржкржирзНржи ржХрж░рзБржи:

**Functions ржЯрзНржпрж╛ржм тЖТ `refunds.complete` ржЦрзБржБржЬрзБржи тЖТ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи**

**Arguments ржП:**
```json
{
  "refundId": "PASTE_REFUND_ID_1",
  "returnCondition": "Full Refund Completed",
  "inspectionNotes": "Admin undo sale process"
}
```

тЬЕ **Call Function** ржХрзНрж▓рж┐ржХ ржХрж░рзБржи

**ржкрзНрж░рждрзНржпрж╛рж╢рж╛:**
```
{
  "success": true,
  "message": "Sale completely undone. All transactions reversed..."
}
```

---

### Refund #2 рж╕ржорзНржкржирзНржи ржХрж░рзБржи:

ржПржХржЗ ржзрж╛ржк, Refund ID #2 рж╕рж╣

---

## тЬЕ ржпрж╛ржЪрж╛ржЗржХрж░ржг ржЪрзЗржХрж▓рж┐рж╕рзНржЯ

### Data ржЯрзЗржмрж┐рж▓рзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи:

1. **refunds ржЯрзЗржмрж┐рж▓:**
   - [ ] ржЙржнржпрж╝ refund ржПрж░ `status = "completed"`
   - [ ] ржЙржнржпрж╝ refund ржПрж░ `isReturned = true`

2. **sales ржЯрзЗржмрж┐рж▓:**
   - [ ] `INV-1769778062695` ржПрж░ `status = "cancelled"`
   - [ ] `INV-1769776643529` ржПрж░ `status = "cancelled"`

3. **products ржЯрзЗржмрж┐рж▓:**
   - [ ] Refund ржХрж░рж╛ ржкржгрзНржпржЧрзБрж▓рж┐рж░ `currentStock` ржмрзГржжрзНржзрж┐ ржкрзЗржпрж╝рзЗржЫрзЗ

4. **customers ржЯрзЗржмрж┐рж▓:**
   - [ ] ржЧрзНрж░рж╛рж╣ржХрзЗрж░ `loyaltyPoints` рж╣рзНрж░рж╛рж╕ ржкрзЗржпрж╝рзЗржЫрзЗ (ржпржжрж┐ ржерж╛ржХрзЗ)

5. **refundAuditTrail ржЯрзЗржмрж┐рж▓:**
   - [ ] рзкржЯрж┐ рж░рзЗржХрж░рзНржб ржкрзНрж░рждрж┐ refund ржП: created, approved, processed, completed

---

## ЁЯОЙ рж╕ржорзНржкрзВрж░рзНржг!

ржпржЦржи рж╕ржм ржЪрзЗржХрж▓рж┐рж╕рзНржЯ рж╕ржорзНржкржирзНржи рж╣ржпрж╝, ржЖржкржирж╛рж░:
- тЬЕ ржжрзБржЯрж┐ ржмрж┐ржХрзНрж░ржпрж╝ cancelled рж╣ржмрзЗ
- тЬЕ ржкрзВрж░рзНржг ржЕрж░рзНрже рж░рж┐ржлрж╛ржирзНржб рж╣ржмрзЗ
- тЬЕ рж╕рзНржЯржХ ржкрзБржирж░рзБржжрзНржзрж╛рж░ рж╣ржмрзЗ
- тЬЕ рж▓ржпрж╝рзНржпрж╛рж▓ржЯрж┐ ржкржпрж╝рзЗржирзНржЯ рж░рж┐ржнрж╛рж░рзНрж╕ рж╣ржмрзЗ
- тЬЕ рж╕ржм ржбрзЗржЯрж╛ рж╕рж╛ржоржЮрзНржЬрж╕рзНржпржкрзВрж░рзНржг рж╣ржмрзЗ

